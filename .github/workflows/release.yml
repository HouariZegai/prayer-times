name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'feat/pipeline'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Get tag name or branch
        id: ref
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "IS_TAG=true" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
            # Remove 'v' prefix if present
            VERSION=${TAG_NAME#v}
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
            echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT
            # Sanitize branch name: replace / and other special chars with -
            SANITIZED_BRANCH=$(echo "${BRANCH_NAME}" | sed 's/[\/_]/-/g' | sed 's/[^a-zA-Z0-9.-]/-/g')
            # Use branch name and commit SHA for version
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            echo "VERSION=${SANITIZED_BRANCH}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Find and prepare distribution file
        id: dist_file
        run: |
          VERSION="${{ steps.ref.outputs.VERSION }}"
          # Check for jlink zip first (preferred - includes JavaFX runtime)
          JLINK_ZIP=$(find target -name "PrayerTimes-*.zip" | head -n 1)
          if [ -n "$JLINK_ZIP" ] && [ -f "$JLINK_ZIP" ]; then
            NEW_NAME="PrayerTimes-${VERSION}-linux.zip"
            cp "$JLINK_ZIP" "target/${NEW_NAME}"
            echo "FILE_PATH=target/${NEW_NAME}" >> $GITHUB_OUTPUT
            echo "FILE_NAME=${NEW_NAME}" >> $GITHUB_OUTPUT
            echo "FILE_TYPE=zip" >> $GITHUB_OUTPUT
          else
            # Fallback to JAR file
            JAR_FILE=$(find target -name "PrayerTimes-*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" | head -n 1)
            if [ -z "$JAR_FILE" ]; then
              echo "Error: No distribution file found in target directory"
              ls -la target/
              exit 1
            fi
            if [ ! -f "$JAR_FILE" ]; then
              echo "Error: JAR file does not exist: $JAR_FILE"
              exit 1
            fi
            NEW_NAME="PrayerTimes-${VERSION}.jar"
            cp "$JAR_FILE" "target/${NEW_NAME}"
            echo "FILE_PATH=target/${NEW_NAME}" >> $GITHUB_OUTPUT
            echo "FILE_NAME=${NEW_NAME}" >> $GITHUB_OUTPUT
            echo "FILE_TYPE=jar" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release (only on tags)
        if: steps.ref.outputs.IS_TAG == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.ref.outputs.TAG_NAME }}
          name: Release ${{ steps.ref.outputs.TAG_NAME }}
          body: |
            ## Release ${{ steps.ref.outputs.TAG_NAME }}
            
            ### Changes
            - See commit history for details
            
            ### Installation
            
            Download ${{ steps.dist_file.outputs.FILE_NAME }} and follow the instructions below:
            
            **If you downloaded the ZIP file (Linux):**
            1. Extract the ZIP file
            2. Navigate to the extracted directory
            3. Run: `./PrayerTimes`
            
            **Note:** The ZIP file includes a custom JavaFX runtime and is built for Linux. For Windows/Mac, please build from source.
            
            **If you downloaded the JAR file:**
            You'll need Java 21+ with JavaFX modules. Run with:
            ```bash
            java --module-path <path-to-javafx-lib> --add-modules javafx.controls,javafx.fxml,javafx.media -jar ${{ steps.dist_file.outputs.FILE_NAME }}
            ```
          files: ${{ steps.dist_file.outputs.FILE_PATH }}
          draft: false
          prerelease: false
      
      - name: Upload artifact (for testing on branch)
        if: steps.ref.outputs.IS_TAG == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: PrayerTimes-${{ steps.ref.outputs.VERSION }}
          path: ${{ steps.dist_file.outputs.FILE_PATH }}
          retention-days: 7

